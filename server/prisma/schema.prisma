// ---------- PRISMA BASICS ----------
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ---------- ENUMS ----------
enum RoomStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
}

enum ResStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
  NO_SHOW
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  VOID
}

enum PayMethod {
  CASH
  BANK_TRANSFER
  CARD
  ONLINE
}

enum PayState {
  INITIATED
  SUCCEEDED
  FAILED
  REFUNDED
}

enum HkState {
  PENDING
  IN_PROGRESS
  DONE
  CANCELLED
}

enum ItemType {
  ROOM_CHARGE
  SERVICE
  SURCHARGE
  DISCOUNT
  DEPOSIT
  TAX
  OTHER
}

enum ChatRole {
  user
  assistant
  system
}

enum UserRole {
  ADMIN
  MANAGER
  RECEPTIONIST
  GUEST
}

enum PriceUnit {
  DAILY
  HOURLY
}

enum UsageUnit {
  NIGHT   // 1 dòng = 1 đêm
  HOUR    // 1 dòng = nhiều giờ (quantity = số giờ tính tiền)
}

enum PolicyKey {
  CHECKIN_TIME
  CHECKOUT_TIME
  DEPOSIT_PERCENT
  EARLY_CHECKIN_FEE
  LATE_CHECKOUT_FEE
}

// ---- ĐÁNH GIÁ / RATING ----
enum ReviewTarget {
  HOTEL
  ROOM_TYPE
  SERVICE
}

enum ReviewStatus {
  PENDING
  PUBLISHED
  REJECTED
  ARCHIVED
}

enum MediaType {
  IMAGE
  VIDEO
}

// ---- KHUYẾN MÃI (gọn) ----
enum PromoType {
  PERCENT
  AMOUNT
}
// ---------- DANH MỤC PHÒNG ----------
model Floor {
  id        Int     @id @default(autoincrement()) @map("ID_TANG")
  name      String  @map("TEN_TANG")
  rooms     Room[]

  @@map("TANG")
}

model RoomType {
  id           Int      @id @default(autoincrement()) @map("ID_LP")
  name         String   @map("TEN_LP")
  maxPeople    Int      @map("SONGUOI_LP")
  ratingAvg    Decimal? @db.Decimal(3,2) @default(0) @map("DG_SAO_TB")
  ratingCount  Int      @default(0)      @map("DG_SO_LUONG")

  rooms        Room[]
  amenities    RoomTypeAmenity[]
  prices       RoomTypePrice[] 
  policies     RoomTypePolicy[]
  reviews      Review[]  @relation("RoomTypeReviews")

  @@map("LOAI_PHONG")
}

model RoomTypePrice {
  id         Int       @id @default(autoincrement()) @map("ID_DG")
  roomTypeId Int       @map("ID_LP")
  unit       PriceUnit @map("DG_DONVI")
  price      Decimal   @db.Decimal(12,2)  @map("DG_DONGIA")
  validFrom  DateTime  @map("DG_NGAYAPDUNG_TU")
  validTo    DateTime? @map("DG_NGAYAPDUNG_DEN")

  roomType RoomType @relation(fields: [roomTypeId], references: [id])

  @@index([roomTypeId, unit, validFrom])
  @@unique([roomTypeId, unit, validFrom])   // mỗi mốc giá bắt đầu chỉ 1 dòng
  @@map("DON_GIA")
}

model Amenity {
  id    Int    @id @default(autoincrement()) @map("ID_TIENNGHI")
  name  String @map("TEN_TIENNGHI")
  roomTypeLinks RoomTypeAmenity[]

  @@map("TIEN_NGHI")
}

// Bảng trung gian: LOAI_PHONG <-> TIEN_NGHI
model RoomTypeAmenity {
  roomTypeId  Int     @map("ID_LP")
  amenityId   Int     @map("ID_TIENNGHI")
  installedAt DateTime? @default(now()) @map("NGAY_TB")
  quantity    Int?    @default(1) @map("SOLUONG_TB")

  roomType RoomType @relation(fields: [roomTypeId], references: [id], onDelete: Cascade)
  amenity  Amenity  @relation(fields: [amenityId], references: [id], onDelete: Cascade)

  @@id([roomTypeId, amenityId])
  @@map("TRANGBI_TIENNGHI")
}

model Room {
  id        Int        @id @default(autoincrement()) @map("ID_PHONG")
  roomTypeId Int       @map("ID_LP")
  floorId   Int        @map("ID_TANG")
  name      String     @map("TEN_PHONG")
  status    RoomStatus @default(AVAILABLE) @map("TRANGTHAI_PHONG")

  usages     ReservationUsage[] 
  hkLogs    HkLog[]

  roomType  RoomType @relation(fields: [roomTypeId], references: [id])
  floor     Floor    @relation(fields: [floorId], references: [id])

  @@map("PHONG")
}

// Lịch sử dọn phòng (nếu bạn muốn giữ đúng tên bảng)
model HkLog {
  id       Int      @id @default(autoincrement()) @map("ID")
  roomId   Int      @map("ID_PHONG")
  state    HkState  @map("TRANG_THAI")
  at       DateTime @default(now()) @map("NGAY_GIO")
  note     String?  @map("GHI_CHU")

  room Room @relation(fields: [roomId], references: [id])

  @@map("LICH_SU_DON_PHONG")
}

// Chính sách toàn khách sạn
model HotelPolicy {
  id                Int       @id @default(autoincrement()) @map("ID_CS")

  // Prisma không có kiểu TIME thuần -> dùng DateTime với native type Time
  checkinTime       DateTime  @db.Time(0) @default(dbgenerated("'14:00:00'")) @map("GIO_CHECKIN")
  checkoutTime      DateTime  @db.Time(0) @default(dbgenerated("'12:00:00'")) @map("GIO_CHECKOUT")

  depositPercent     Decimal   @db.Decimal(5, 2) @default(0) @map("TIEN_DAT_COC")
  earlyCheckinFee   Decimal   @db.Decimal(12, 2) @default(0) @map("PHI_CHECKIN_SOM")
  lateCheckoutFee   Decimal   @db.Decimal(12, 2) @default(0) @map("PHI_CHECKOUT_TRE")

  updatedById       Int?      @map("NGUOI_CAPNHAT")
  updatedAt         DateTime  @default(now()) @updatedAt @map("NGAY_CAPNHAT")

  // FK -> USERS(ID_USER)
  updatedBy         User?     @relation(fields: [updatedById], references: [id], name: "PolicyUpdatedBy")

  @@map("CHINH_SACH")
}


model RoomTypePolicy {
  roomTypeId Int       @map("ID_LP")
  key        PolicyKey @map("KHOA")
  timeValue    DateTime? @db.Time(0)   @map("GIA_TRI_GIO")
  decimalValue Decimal?  @db.Decimal(12,2) @map("GIA_TRI_SO")

  roomType   RoomType  @relation(fields: [roomTypeId], references: [id], onDelete: Cascade)

  @@id([roomTypeId, key])
  @@map("LP_CHINH_SACH")
}

// ---------- USER (đã gộp KHÁCH) ----------
model User {
  id        Int      @id @default(autoincrement()) @map("ID_USER")
  role      UserRole @default(GUEST) @map("CHUC_VU_USER")

  // cho phép null để hỗ trợ khách chưa đăng ký tài khoản
  username  String?  @unique @map("USERNAME")
  password  String?  @map("MATKHAU_USER")

  // hồ sơ (gộp từ Guest)
  fullName  String?  @map("HOTEN")
  phone     String?  @unique @map("SODIENTHOAI")
  email     String?  @map("EMAIL")
  address   String?  @map("DIACHI")
  idCard    String?  @map("CCCD")

  // quan hệ
  createdReservations Reservation[] @relation("ReservationCreatedBy")
  handledReservations Reservation[] @relation("ReservationHandledBy")
  guestReservations   Reservation[] @relation("ReservationGuest")

  invoices  Invoice[]     @relation("InvoiceCreator")
  updatedPolicies HotelPolicy[] @relation("PolicyUpdatedBy")

  chatSessions ChatSession[]
  // reviews/votes/replies sẽ được định nghĩa ở các model tương ứng
  reviewsAuthored Review[]       @relation("UserReviewsAuthored")
  reviewReplies   ReviewReply[]  @relation("UserReviewReplies")
  reviewVotes     ReviewVote[]   @relation("UserReviewVotes")
  promotionUsages PromotionUsage[] @relation("UserPromotionUsages")

  @@map("USERS")
}



// ---------- ĐẶT PHÒNG ----------
model Reservation {
  id          Int       @id @default(autoincrement()) @map("ID_HOPDONG")
  guestId     Int       @map("ID_KH")
  createdByUserId    Int?      @map("CREATED_BY_USER_ID")    // khách hoặc lễ tân tạo
  handledByUserId    Int?      @map("HANDLED_BY_USER_ID")    // lễ tân phụ trách
  checkInPlan DateTime  @map("NGAYDAT")
  checkOutPlan DateTime @map("NGAYTRA")
  checkInAt   DateTime? @map("CHECKIN_AT")
  checkOutAt  DateTime? @map("CHECKOUT_AT")
  status      ResStatus @default(PENDING) @map("TRANG_THAI_HDONG")
  createdAt   DateTime  @default(now()) @map("TAO_NGAY")
  updatedAt   DateTime? @map("SUA_NGAY")
  note        String?   @map("GHICHU_HDDP")

  guest User  @relation("ReservationGuest",fields: [guestId], references: [id])
  createdBy User? @relation("ReservationCreatedBy", fields: [createdByUserId], references: [id])
  handledBy User? @relation("ReservationHandledBy", fields: [handledByUserId], references: [id])

  usages    ReservationUsage[]
  services  ReservationService[]
  invoiceLinks InvoiceReservation[]
  reviews   Review[]

  promoUsages PromotionUsage[] @relation("ReservationPromotionUsages")

  @@index([guestId, status], map: "idx_res_guest_status")
  @@index([checkInPlan, checkOutPlan], map: "idx_res_dates")
  @@map("HOP_DONG_DAT_PHONG")
}

// Chi tiết sử dụng: 1 dòng = 1 đêm (NIGHT) hoặc 1 block giờ (HOUR)
model ReservationUsage {
  id            Int       @id @default(autoincrement()) @map("ID_CTDP")
  reservationId Int       @map("ID_HOPDONG")
  roomId        Int       @map("ID_PHONG")
  unit          UsageUnit @map("CTDP_DONVI")       // NIGHT | HOUR
  date          DateTime? @map("NGAY_DA_O")       // dùng khi unit = NIGHT (1 đêm)
  startAt       DateTime? @map("O_TU_GIO")        // dùng khi unit = HOUR
  endAt         DateTime? @map("O_DEN_GIO")       // dùng khi unit = HOUR
  quantity      Int       @map("SO_LUONG_GIO")       // NIGHT: 1; HOUR: số giờ tính tiền (đã làm tròn)
  unitPrice     Decimal  @db.Decimal(12,2)   @map("DON_GIA_DP")
  amount        Decimal  @db.Decimal(12,2)   @map("CTDP_THANH_TIEN")

  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  room        Room        @relation(fields: [roomId], references: [id], onDelete: Restrict)

  @@unique([reservationId, roomId, unit, date])
  @@index([reservationId, roomId, unit])
  @@index([roomId, unit, date])
  @@map("CHI_TIET_SU_DUNG")
}

// ---------- DỊCH VỤ ----------
model ServiceCategory {
  id   Int    @id @default(autoincrement()) @map("ID_LOAIDICHVU")
  name String @map("TEN_LOAIDICHVU")
  services Service[]

  @@map("LOAI_DICH_VU")
}

model Service {
  id        Int      @id @default(autoincrement()) @map("ID_DV")
  categoryId Int     @map("ID_LOAIDICHVU")
  name      String   @map("TEN_DV")
  price     Decimal  @db.Decimal(12,2) @map("DONGIA_DV")
  cost      Decimal? @db.Decimal(12,2) @map("GIAVON_DV")
  stock     Int?     @map("TONKHO_DV")
  unit      String?  @map("DONVI_DV")
  ratingAvg   Decimal? @db.Decimal(3,2) @default(0) @map("DG_SAO_TB")
  ratingCount Int      @default(0)      @map("DG_SO_LUONG")

  used      ReservationService[]
  category ServiceCategory @relation(fields: [categoryId], references: [id])
  reviews   Review[] @relation("ServiceReviews")

  @@map("DICH_VU")
}

model ReservationService {
  id            Int      @id @default(autoincrement()) @map("ID_HDDV")
  reservationId Int      @map("ID_HOPDONG")
  serviceId     Int      @map("ID_DV")
  usedAt        DateTime @default(now()) @map("NGAY_HDDV")
  quantity      Int      @map("SOLUONG_HDDV")
  unitPrice     Decimal  @db.Decimal(12,2) @map("DONGIA_HDDV")
  note          String?  @map("GHICHU_HDDV")

  reservation Reservation @relation(fields: [reservationId], references: [id])
  service     Service     @relation(fields: [serviceId], references: [id])

  @@index([reservationId])
  @@map("CHI_TIET_DICH_VU")
}

// ---------- HÓA ĐƠN & THANH TOÁN ----------
model Invoice {
  id          Int           @id @default(autoincrement()) @map("ID_HD")
  userId      Int           @map("ID_USER")
  subTotal    Decimal       @db.Decimal(12,2) @default(0) @map("TONG_TIEN")
  grandTotal  Decimal       @db.Decimal(12,2) @default(0) @map("THANH_TIEN_HDON")
  status      InvoiceStatus @default(ISSUED) @map("TRANG_THAI_HDON")

  user        User        @relation("InvoiceCreator", fields: [userId], references: [id])
  reservations InvoiceReservation[] 
  items     InvoiceItem[]
  payments  Payment[]
  promoUsages PromotionUsage[] @relation("InvoicePromotionUsages")

  @@map("HOA_DON")
}

model InvoiceItem {
  id        Int      @id @default(autoincrement()) @map("ID_CTHD")
  invoiceId Int      @map("ID_HD")
  type      ItemType @map("LOAI_SP")
  description String @map("MOTA")
  quantity  Int      @default(1) @map("SO_LUONG")
  unitPrice Decimal  @db.Decimal(12,2) @map("DON_GIA")

  invoice   Invoice  @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId, type])
  @@map("CHI_TIET_HOA_DON")
}

model Payment {
  id        Int       @id @default(autoincrement()) @map("ID_TT")
  invoiceId Int       @map("ID_HD")
  method    PayMethod @map("TT_PHUONG_THUC")
  state     PayState  @default(SUCCEEDED) @map("TT_TRANG_THAI_GIAO_DICH")
  amount    Decimal   @db.Decimal(12,2) @map("TT_SO_TIEN_KHACH_DUA")
  paidAt    DateTime  @default(now()) @map("TT_NGAY_GIO")
  transCode String?   @map("TT_MA_GIAO_DICH")

  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId, state])
  @@map("THANH_TOAN")
}

// Bảng nối: gộp nhiều Reservation vào 1 Invoice (và ngược lại)
model InvoiceReservation {
  invoiceId     Int
  reservationId Int

  invoice     Invoice     @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@id([invoiceId, reservationId])
  @@map("HOA_DON_HOP_DONG")
}

// ---------- CHATBOT ----------
model ChatSession {
  id        Int      @id @default(autoincrement()) @map("ID_SESSION")
  guestId   Int?     @map("ID_KH")
  startedAt DateTime @default(now()) @map("STARTED_AT")

  guest     User?   @relation(fields: [guestId], references: [id])
  messages  ChatMessage[]

  @@map("CHAT_SESSION")
}

model ChatMessage {
  id         BigInt   @id @default(autoincrement()) @map("ID_MES")
  sessionId  Int      @map("ID_SESSION")
  role       ChatRole @map("ROLE")
  content    String   @map("CONTENT")
  createdAt  DateTime @default(now()) @map("CREATED_AT")

  session ChatSession @relation(fields: [sessionId], references: [id])

  @@index([sessionId, createdAt])
  @@map("CHAT_MESSAGE")
}

// ---------- KNOWLEDGE BASE ----------
model KbDocument {
  id        Int       @id @default(autoincrement()) @map("ID_DOC")
  title     String?   @map("TITLE")
  sourceUrl String?   @map("SOURCE_URL")
  tags      String?   @map("TAGS")
  createdAt DateTime  @default(now()) @map("CREATED_AT")
  chunks    KbChunk[]

  @@map("KB_DOCUMENT")
}

model KbChunk {
  id         Int      @id @default(autoincrement()) @map("ID_CHUNK")
  docId      Int      @map("ID_DOC")
  content    String   @map("CONTENT")
  embedding  Json     @map("EMBEDDING_JSON")
  tokenCount Int?     @map("TOKEN_COUNT")
  createdAt  DateTime @default(now()) @map("CREATED_AT")

  doc KbDocument @relation(fields: [docId], references: [id])

  @@index([docId])
  @@map("KB_CHUNK")
}

model Review {
  id            Int           @id @default(autoincrement()) @map("ID_DG")

  authorId      Int           @map("ID_USER")
  author        User          @relation("UserReviewsAuthored", fields: [authorId], references: [id], onDelete: Cascade)

  reservationId Int?          @map("ID_HOPDONG")
  reservation   Reservation?  @relation(fields: [reservationId], references: [id], onDelete: SetNull)

  target        ReviewTarget  @map("DG_DOITUONG")
  roomTypeId    Int?          @map("ID_LP")
  roomType      RoomType?     @relation("RoomTypeReviews", fields: [roomTypeId], references: [id], onDelete: SetNull)
  serviceId     Int?          @map("ID_DV")
  service       Service?      @relation("ServiceReviews", fields: [serviceId], references: [id], onDelete: SetNull)

  rating        Int           @map("DG_SAO")
  title         String?       @map("DG_TIEUDE")
  content       String?       @db.Text @map("DG_NOIDUNG")
  isAnonymous   Boolean       @default(false) @map("DG_AN_DANH")
  isVerified    Boolean       @default(false) @map("DG_DA_XACMINH")

  status        ReviewStatus  @default(PENDING) @map("DG_TRANGTHAI")
  createdAt     DateTime      @default(now()) @map("TAO_LUC")
  publishedAt   DateTime?     @map("CONG_BO_LUC")

  helpfulUp     Int           @default(0) @map("DG_HUUICH_UP")
  helpfulDown   Int           @default(0) @map("DG_HUUICH_DOWN")
  helpfulScore  Int           @default(0) @map("DG_HUUICH_SCORE")

  media         ReviewMedia[]
  votes         ReviewVote[]
  reply         ReviewReply?

  @@unique([authorId, target, roomTypeId, serviceId, reservationId], map: "uniq_author_target_resv")
  @@index([status, target], map: "idx_review_status_target")
  @@index([roomTypeId], map: "idx_review_roomtype")
  @@index([serviceId], map: "idx_review_service")
  @@map("DANH_GIA")
}

model ReviewMedia {
  id        Int        @id @default(autoincrement()) @map("ID_DG_MEDIA")
  reviewId  Int        @map("ID_DG")
  review    Review     @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  type      MediaType  @map("LOAI")
  url       String     @map("URL")
  caption   String?    @map("CHUTHICH")
  createdAt DateTime   @default(now()) @map("TAO_LUC")

  @@index([reviewId])
  @@map("DG_MEDIA")
}

model ReviewReply {
  id        Int      @id @default(autoincrement()) @map("ID_PH")
  reviewId  Int      @unique @map("ID_DG")
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  userId    Int      @map("ID_USER")
  user      User     @relation("UserReviewReplies", fields: [userId], references: [id], onDelete: Restrict)

  content   String   @db.Text @map("NOIDUNG")
  createdAt DateTime @default(now()) @map("TAO_LUC")

  @@map("DG_PHAN_HOI")
}

model ReviewVote {
  reviewId  Int      @map("ID_DG")
  voterId   Int      @map("ID_USER")
  value     Int      @default(1) @map("GIA_TRI")
  createdAt DateTime @default(now()) @map("TAO_LUC")

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  voter  User   @relation("UserReviewVotes", fields: [voterId], references: [id], onDelete: Cascade)

  @@id([reviewId, voterId])                // composite PK: 1 người chỉ vote 1 lần/review
  @@index([reviewId], map: "idx_vote_review")
  @@map("DG_BO_PHIEU")
}

// ---------- KHUYẾN MÃI (gọn vừa – 2 bảng) ----------
model Promotion {
  id        Int        @id @default(autoincrement()) @map("ID_KM")
  code      String     @unique @map("MA_KM")
  type      PromoType  @map("KM_LOAI")
  value     Decimal    @db.Decimal(12,2) @map("KM_GIA_TRI")  // 5 = 5% nếu PERCENT
  startAt   DateTime?  @map("KM_TU")
  endAt     DateTime?  @map("KM_DEN")
  isActive  Boolean    @default(true) @map("KM_HIEULUC")

  usages    PromotionUsage[]

  @@map("KHUYEN_MAI")
}

model PromotionUsage {
  promotionId   Int   @map("ID_KHUYEN_MAI")
  reservationId Int   @map("ID_HOPDONG")
  userId        Int   @map("ID_USER")
  invoiceId     Int?  @map("ID_HDON")         // (tuỳ) link hóa đơn có dòng DISCOUNT
  amount        Decimal @db.Decimal(12,2) @map("KM_SOTIEN_GIAM")
  appliedAt     DateTime @default(now()) @map("KM_NGAY_SD")

  promotion   Promotion   @relation(fields: [promotionId], references: [id], onDelete: Restrict)
  reservation Reservation @relation("ReservationPromotionUsages", fields: [reservationId], references: [id], onDelete: Cascade)
  user        User        @relation("UserPromotionUsages", fields: [userId], references: [id], onDelete: Restrict)
  invoice     Invoice?    @relation("InvoicePromotionUsages", fields: [invoiceId], references: [id], onDelete: SetNull)

  @@id([promotionId, reservationId])   // mỗi HĐ chỉ dùng 1 lần mã này
  @@index([reservationId])
  @@index([userId])
  @@index([invoiceId])
  @@map("KHUYEN_MAI_SU_DUNG")
}