// ---------- PRISMA BASICS ----------
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ---------- ENUMS ----------
enum TRANGTHAI_PHONG {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
  CHUA_DON
}

enum TRANGTHAI_HOPDONG {
  PENDING // chưa đặt cọc
  CONFIRMED // đã cọc
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
  NO_SHOW
}

enum TRANGTHAI_HOADON {
  DRAFT
  ISSUED
  PAID
  VOID
}

enum PHUONGTHUC_TT {
  CASH
  BANK_QR
  CARD
  GATEWAY
}

enum TRANGTHAI_TT {
  INITIATED
  SUCCEEDED
  FAILED
  REFUNDED
}

enum TRANGTHAI_DONPHONG {
  PENDING
  IN_PROGRESS
  DONE
  CANCELLED
}

enum ChatRole {
  user
  assistant
  system
}

enum UserRole {
  ADMIN
  RECEPTIONIST
  GUEST
}

enum DG_TrangThai {
  PUBLISHED
  ARCHIVED
}

enum MEDIA_Loai {
  IMAGE
  VIDEO
}

enum KM_KieuApDung {
  PERCENT
  AMOUNT
}

enum CTSD_TrangThai {
  ACTIVE
  CANCELLED
  INVOICED
  DOI_PHONG
}

enum CTDV_TrangThai {
  ACTIVE
  CANCELLED
  INVOICED
  DOI_PHONG
}

enum LOAI_HOA_DON {
  DEPOSIT
  MAIN
}

// ---------- DANH MỤC PHÒNG ----------
model TANG {
  TANG_MA  Int    @id @default(autoincrement())
  TANG_TEN String

  PHONG PHONG[]
}

model LOAI_PHONG {
  LP_MA      Int    @id @default(autoincrement())
  LP_TEN     String
  LP_SONGUOI Int
  LP_TRANGTHAI String  @default("DANG_KINH_DOANH")

  images      LOAI_PHONG_IMAGE[]
  PHONG            PHONG[]
  TRANGBI_TIENNGHI TRANGBI_TIENNGHI[]
  DON_GIA          DON_GIA[]
  CT_DAT_TRUOC CT_DAT_TRUOC[]     // Một hợp đồng có thể có nhiều dòng đặt trước

}

model LOAI_PHONG_IMAGE {
  IMG_ID     Int    @id @default(autoincrement())
  LP_MA      Int
  URL        String           // link file
  IS_MAIN    Boolean @default(false)
  ORD        Int?             // thứ tự hiển thị
  createdAt  DateTime @default(now())

  loaiPhong  LOAI_PHONG @relation(fields: [LP_MA], references: [LP_MA], onDelete: Cascade)
}

model HINH_THUC_THUE {
  HT_MA   Int     @id @default(autoincrement())
  HT_TEN  String  @unique
  HT_MOTA String?

  DON_GIA            DON_GIA[]
  HOP_DONG_DAT_PHONG HOP_DONG_DAT_PHONG[] // nếu muốn gắn HT vào HĐ, bật thêm cột ở HOP_DONG
}

model THOI_DIEM {
  TD_MA        Int     @id @default(autoincrement())
  TD_TEN       String
  TD_TRANGTHAI Boolean @default(true)

  THOI_DIEM_BASE    THOI_DIEM_BASE?
  THOI_DIEM_SPECIAL THOI_DIEM_SPECIAL?
  DON_GIA           DON_GIA[]
}

// subtype BASE (không cột ngày) giá cơ bản
model THOI_DIEM_BASE {
  TD_MA         Int     @id
  TD_MOTA_CHUNG String?

  THOI_DIEM THOI_DIEM @relation(fields: [TD_MA], references: [TD_MA], onDelete: Cascade)
}

// subtype SPECIAL (có khoảng ngày)
model THOI_DIEM_SPECIAL {
  TD_MA             Int      @id
  TD_NGAY_BAT_DAU   DateTime
  TD_NGAY_KET_THUC  DateTime
  TD_MOTA_CHIENDICH String?

  THOI_DIEM THOI_DIEM @relation(fields: [TD_MA], references: [TD_MA], onDelete: Cascade)

  @@index([TD_NGAY_BAT_DAU, TD_NGAY_KET_THUC])
}

// NEW: Đơn giá = Loại phòng × Hình thức × Thời điểm (PK tổng hợp)
model DON_GIA {
  LP_MA Int
  HT_MA Int
  TD_MA Int

  DG_DONGIA Decimal @db.Decimal(14, 2)

  LOAI_PHONG     LOAI_PHONG     @relation(fields: [LP_MA], references: [LP_MA], onDelete: Cascade)
  HINH_THUC_THUE HINH_THUC_THUE @relation(fields: [HT_MA], references: [HT_MA])
  THOI_DIEM      THOI_DIEM      @relation(fields: [TD_MA], references: [TD_MA], onDelete: Cascade)

  @@id([LP_MA, HT_MA, TD_MA])
}

model TIEN_NGHI {
  TN_MA  Int    @id @default(autoincrement())
  TN_TEN String

  TRANGBI_TIENNGHI TRANGBI_TIENNGHI[]
}

// Bảng trung gian: LOAI_PHONG <-> TIEN_NGHI
model TRANGBI_TIENNGHI {
  LP_MA      Int
  TN_MA      Int
  TN_NGAY_TB DateTime? @default(now())
  TN_SOLUONG Int?      @default(1)

  LOAI_PHONG LOAI_PHONG @relation(fields: [LP_MA], references: [LP_MA], onDelete: Cascade)
  TIEN_NGHI  TIEN_NGHI  @relation(fields: [TN_MA], references: [TN_MA], onDelete: Cascade)

  @@id([LP_MA, TN_MA])
}

model PHONG {
  PHONG_MA        Int             @id @default(autoincrement())
  LP_MA           Int
  TANG_MA         Int
  PHONG_TEN       String          @unique
  PHONG_TRANGTHAI TRANGTHAI_PHONG @default(AVAILABLE)

  CHI_TIET_SU_DUNG  CHI_TIET_SU_DUNG[]
  LICH_SU_DON_PHONG LICH_SU_DON_PHONG[]
  CHI_TIET_DICH_VU  CHI_TIET_DICH_VU[]

  LOAI_PHONG LOAI_PHONG @relation(fields: [LP_MA], references: [LP_MA])
  TANG       TANG       @relation(fields: [TANG_MA], references: [TANG_MA])
}

model LICH_SU_DON_PHONG {
  LSDP_MA        Int                @id @default(autoincrement())
  PHONG_MA       Int
  LSDP_TRANGTHAI TRANGTHAI_DONPHONG
  LSDP_NGAYGIO   DateTime           @default(now())
  LSDP_GHICHU    String?

  PHONG PHONG @relation(fields: [PHONG_MA], references: [PHONG_MA])
}

// ---------- NHÂN VIÊN Và KHÁCH HÀNG ----------

model KHACH_HANG {
  KH_MA       Int       @id @default(autoincrement())
  KH_HOTEN    String
  KH_NGAYSINH DateTime? // có thể null
  KH_GIOITINH String? // Nam/Nữ/Khác
  KH_CCCD     String?    @unique // giấy tờ tuỳ thân
  KH_EMAIL    String?   @unique
  KH_SDT      String    @unique
  KH_DIACHI   String?
  KH_TAIKHOAN String?   @unique // username nếu có tài khoản web
  KH_MATKHAU  String? // hash mật khẩu nếu có tài khoản
  KH_NGAYTAO  DateTime  @default(now())
  KH_NGAYSUA  DateTime  @updatedAt

  HOP_DONG_DAT_PHONG HOP_DONG_DAT_PHONG[]
  DANH_GIA           DANH_GIA[]
  LUU_TRU_KHACH      LUU_TRU_KHACH[]
  ChatSession        ChatSession[]
}

model LUU_TRU_KHACH {
  KH_MA          Int
  HDONG_MA       Int
  LA_KHACH_CHINH Boolean @default(false)
  LA_KHACH_DAT   Boolean @default(false)
  GHI_CHU        String?

  HOP_DONG_DAT_PHONG HOP_DONG_DAT_PHONG @relation(fields: [HDONG_MA], references: [HDONG_MA], onDelete: Cascade)
  KHACH_HANG         KHACH_HANG         @relation(fields: [KH_MA], references: [KH_MA], onDelete: Restrict)

  @@id([HDONG_MA, KH_MA])
  @@index([KH_MA])
  @@index([HDONG_MA, LA_KHACH_CHINH])
  @@index([HDONG_MA, LA_KHACH_DAT])
}

model NHAN_VIEN {
  NV_MA        Int       @id @default(autoincrement())
  NV_HOTEN     String
  NV_EMAIL     String?   @unique
  NV_SDT       String    @unique
  NV_NGAYSINH  DateTime?
  NV_GIOITINH  String?
  NV_CHUCVU    String // Lễ tân / Quản lý / Admin...
  NV_TAIKHOAN  String    @unique
  NV_MATKHAU   String
  NV_TRANGTHAI String    @default("DANG_LAM")
  NV_NGAYTAO   DateTime  @default(now())
  NV_NGAYSUA   DateTime  @updatedAt

  HOP_DONG_DAT_PHONG HOP_DONG_DAT_PHONG[]
  HOA_DON            HOA_DON[]
  PHAN_HOI           PHAN_HOI[]
  CHI_TIET_SU_DUNG   CHI_TIET_SU_DUNG[]
  CHI_TIET_DICH_VU   CHI_TIET_DICH_VU[]
}

// ---------- ĐẶT PHÒNG ----------
model HOP_DONG_DAT_PHONG {
  HDONG_MA Int  @id @default(autoincrement())
  KH_MA    Int
  NV_MA    Int?
  HT_MA    Int

  HDONG_NGAYDAT      DateTime
  HDONG_NGAYTRA      DateTime
  HDONG_NGAYTHUCNHAN DateTime?
  HDONG_NGAYTHUCTRA  DateTime?

  HDONG_TONGTIENDUKIEN Decimal @default(0) @db.Decimal(14, 2)
  HDONG_TILECOCAPDUNG  Decimal @default(0) @db.Decimal(5, 2)
  HDONG_TIENCOCYEUCAU  Decimal @default(0) @db.Decimal(14, 2)

  HDONG_TRANG_THAI TRANGTHAI_HOPDONG @default(PENDING)
  HDONG_TAO_LUC    DateTime          @default(now())
  HDONG_SUA_LUC    DateTime?
  HDONG_GHICHU     String?

  KHUYEN_MAI_SU_DUNG KHUYEN_MAI_SU_DUNG?
  DANH_GIA           DANH_GIA?

  CHI_TIET_SU_DUNG CHI_TIET_SU_DUNG[]
  CHI_TIET_DICH_VU CHI_TIET_DICH_VU[]
  LIEN_KET         HOA_DON_HOP_DONG[]

  KHACH_HANG     KHACH_HANG      @relation(fields: [KH_MA], references: [KH_MA])
  NHAN_VIEN      NHAN_VIEN?      @relation(fields: [NV_MA], references: [NV_MA])
  HINH_THUC_THUE HINH_THUC_THUE  @relation(fields: [HT_MA], references: [HT_MA])
  LUU_TRU_KHACH  LUU_TRU_KHACH[]
  CT_DAT_TRUOC CT_DAT_TRUOC[]     // Một hợp đồng có thể có nhiều dòng đặt trước

  @@index([KH_MA, HDONG_TRANG_THAI])
  @@index([HDONG_NGAYDAT, HDONG_NGAYTRA])
}

model CT_DAT_TRUOC {
  CTDP_ID      Int      @id @default(autoincrement())
  HDONG_MA     Int
  LP_MA        Int
  SO_LUONG     Int       @default(1)
  DON_GIA      Float     @default(0)
  TONG_TIEN    Float     @default(0)
  TRANG_THAI   String    @default("CONFIRMED") // CONFIRMED | ALLOCATED | CANCELLED
  NGAY_TAO     DateTime  @default(now())

  // --- Quan hệ ---
  HOP_DONG_DAT_PHONG  HOP_DONG_DAT_PHONG @relation(fields: [HDONG_MA], references: [HDONG_MA])
  LOAI_PHONG          LOAI_PHONG         @relation(fields: [LP_MA], references: [LP_MA])

  @@map("CT_DAT_TRUOC")
}


//vì các cột thời gian có thể NULL, hãy đảm bảo logic ở code: THEO_NGAY ⇒ chỉ set CTSD_NGAY_DA_O, để 2 cột giờ NULL.THEO_GIO ⇒ chỉ set O_TU_GIO, O_DEN_GIO, để NGAY_DA_O NULL
model CHI_TIET_SU_DUNG {
  CTSD_STT       Int
  HDONG_MA       Int
  PHONG_MA       Int
  CTSD_NGAY_DA_O DateTime? // dùng khi DONVI = NIGHT (1 đêm)
  CTSD_O_TU_GIO  DateTime? // dùng khi DONVI = HOUR
  CTSD_O_DEN_GIO DateTime? // dùng khi DONVI = HOUR
  CTSD_SO_LUONG  Int
  CTSD_DON_GIA   Decimal   @db.Decimal(12, 2)
  CTSD_TONG_TIEN Decimal   @db.Decimal(12, 2)

  CTSD_TRANGTHAI CTSD_TrangThai @default(ACTIVE)
  CTSD_HUY_LUC   DateTime?
  CTSD_HUY_LYDO  String?
  CTSD_HUY_NV    Int?

  CHI_TIET_DICH_VU CHI_TIET_DICH_VU[] @relation("CTSD_to_CTDV")

  HOP_DONG_DAT_PHONG HOP_DONG_DAT_PHONG @relation(fields: [HDONG_MA], references: [HDONG_MA], onDelete: Cascade)
  PHONG              PHONG              @relation(fields: [PHONG_MA], references: [PHONG_MA], onDelete: Restrict)
  HUY_NV             NHAN_VIEN?         @relation(fields: [CTSD_HUY_NV], references: [NV_MA])

  @@id([HDONG_MA, PHONG_MA, CTSD_STT])
  @@unique([HDONG_MA, PHONG_MA, CTSD_NGAY_DA_O], map: "uniq_ctsd_night")
  @@unique([HDONG_MA, PHONG_MA, CTSD_O_TU_GIO, CTSD_O_DEN_GIO], map: "uniq_ctsd_hour")
}

// ---------- DỊCH VỤ ----------
model LOAI_DICH_VU {
  LDV_MA  Int    @id @default(autoincrement())
  LDV_TEN String

  DICH_VU DICH_VU[]
}

model DICH_VU {
  DV_MA     Int     @id @default(autoincrement())
  LDV_MA    Int
  DV_TEN    String
  DV_DONGIA Decimal @db.Decimal(12, 2)

  CHI_TIET_DICH_VU CHI_TIET_DICH_VU[]
  LOAI_DICH_VU     LOAI_DICH_VU       @relation(fields: [LDV_MA], references: [LDV_MA])
}

model CHI_TIET_DICH_VU {
  CTDV_STT Int
  HDONG_MA Int
  PHONG_MA Int
  CTSD_STT Int
  DV_MA    Int

  CTDV_NGAY    DateTime @default(now())
  CTDV_SOLUONG Int
  CTDV_DONGIA  Decimal  @db.Decimal(12, 2)
  CTDV_GHICHU  String?

  CTDV_TRANGTHAI CTDV_TrangThai @default(ACTIVE)
  CTDV_HUY_LUC   DateTime?
  CTDV_HUY_LYDO  String?
  CTDV_HUY_NV    Int?

  DICH_VU                    DICH_VU             @relation(fields: [DV_MA], references: [DV_MA])
  CTSD                       CHI_TIET_SU_DUNG    @relation(name: "CTSD_to_CTDV", fields: [HDONG_MA, PHONG_MA, CTSD_STT], references: [HDONG_MA, PHONG_MA, CTSD_STT], onDelete: Cascade)
  HUY_NV                     NHAN_VIEN?          @relation(fields: [CTDV_HUY_NV], references: [NV_MA])
  PHONG                      PHONG?              @relation(fields: [pHONGPHONG_MA], references: [PHONG_MA])
  pHONGPHONG_MA              Int?
  HOP_DONG_DAT_PHONG         HOP_DONG_DAT_PHONG? @relation(fields: [hOP_DONG_DAT_PHONGHDONG_MA], references: [HDONG_MA])
  hOP_DONG_DAT_PHONGHDONG_MA Int?

  @@id([HDONG_MA, PHONG_MA, CTSD_STT, DV_MA, CTDV_STT])
  @@index([HDONG_MA, PHONG_MA, CTSD_STT])
  @@index([DV_MA, CTDV_NGAY])
  @@index([HDONG_MA])
}

//-----------KHUYẾN MÃI---------------

model KHUYEN_MAI {
  ID_KM         Int           @id @default(autoincrement()) @map("ID_KM")
  KM_MA         String        @unique
  KM_TEN        String
  KM_MOTA       String
  KM_KIEUAPDUNG KM_KieuApDung
  KM_GIA_TRI    Decimal       @db.Decimal(12, 2) // 5 = 5% nếu PERCENT
  KM_TU         DateTime
  KM_DEN        DateTime?
  KM_HIEU_LUC   Boolean

  KHUYEN_MAI_SU_DUNG KHUYEN_MAI_SU_DUNG[]
}

model KHUYEN_MAI_SU_DUNG {
  ID_KM          Int
  HDONG_MA       Int
  KM_SOTIEN_GIAM Decimal  @db.Decimal(12, 2)
  KM_NGAY_SD     DateTime @default(now())

  KHUYEN_MAI         KHUYEN_MAI         @relation(fields: [ID_KM], references: [ID_KM], onDelete: Restrict)
  HOP_DONG_DAT_PHONG HOP_DONG_DAT_PHONG @relation(fields: [HDONG_MA], references: [HDONG_MA], onDelete: Cascade)

  @@id([ID_KM, HDONG_MA]) // 1 mã X 1 HĐ: duy nhất
  @@unique([HDONG_MA]) // mỗi HĐ chỉ có 1 mã
  @@index([ID_KM])
}

//------ĐÁNH GIÁ-------

model DANH_GIA {
  DG_MA    Int @id @default(autoincrement())
  KH_MA    Int
  HDONG_MA Int

  DG_SAO      Int // 1..5 (check ở code)
  DG_TIEU_DE  String
  DG_NOI_DUNG String? @db.Text

  DG_TRANG_THAI DG_TrangThai @default(PUBLISHED)
  DG_TAO_LUC    DateTime     @default(now())

  DINH_KEMS DINH_KEM_DANH_GIA[]
  PHAN_HOI  PHAN_HOI?

  HOP_DONG_DAT_PHONG HOP_DONG_DAT_PHONG @relation(fields: [HDONG_MA], references: [HDONG_MA], onDelete: Cascade)
  KHACH_HANG         KHACH_HANG         @relation(fields: [KH_MA], references: [KH_MA], onDelete: Restrict)

  @@unique([HDONG_MA])
  @@index([HDONG_MA, DG_TRANG_THAI])
}

model DINH_KEM_DANH_GIA {
  DKDG_MA       Int        @id @default(autoincrement())
  DG_MA         Int
  DKDG_LOAI     MEDIA_Loai
  DKDG_URL      String
  DKDG_CHUTHICH String?

  DANH_GIA DANH_GIA @relation(fields: [DG_MA], references: [DG_MA], onDelete: Cascade)
}

model PHAN_HOI {
  PH_MA      Int      @id @default(autoincrement())
  DG_MA      Int      @unique // 1 review -> 1 phản hồi (nếu muốn cho nhiều phản hồi, bỏ @unique)
  NV_MA      Int
  PH_NOIDUNG String   @db.Text
  PH_TAO_LUC DateTime @default(now())

  DANH_GIA  DANH_GIA  @relation(fields: [DG_MA], references: [DG_MA], onDelete: Cascade)
  NHAN_VIEN NHAN_VIEN @relation(fields: [NV_MA], references: [NV_MA], onDelete: Restrict)
}

// ---------- HÓA ĐƠN & THANH TOÁN ----------
model HOA_DON {
  HDON_MA           Int              @id @default(autoincrement())
  NV_MA             Int
  HDON_LOAI         LOAI_HOA_DON     @default(MAIN) 
  HDON_TONG_TIEN    Decimal          @default(0) @db.Decimal(12, 2)
  HDON_GIAM_GIA     Decimal          @default(0) @db.Decimal(12, 2)
  HDON_PHI          Decimal          @default(0) @db.Decimal(12, 2)
  HDON_COC_DA_TRU   Decimal          @default(0) @db.Decimal(12, 2)
  HDON_THANH_TIEN   Decimal          @default(0) @db.Decimal(12, 2)
  HDON_CHITIET_JSON Json
  HDON_TRANG_THAI   TRANGTHAI_HOADON @default(ISSUED)
  HDON_TAO_LUC      DateTime         @default(now())

  NHAN_VIEN  NHAN_VIEN          @relation(fields: [NV_MA], references: [NV_MA])
  LIEN_KET   HOA_DON_HOP_DONG[]
  THANH_TOAN THANH_TOAN[]
}

model THANH_TOAN {
  TT_MA                   Int           @id @default(autoincrement())
  HDON_MA                 Int
  TT_PHUONG_THUC          PHUONGTHUC_TT
  TT_NHA_CUNG_CAP         String?
  TT_TRANG_THAI_GIAO_DICH TRANGTHAI_TT  @default(INITIATED)
  TT_SO_TIEN              Decimal       @db.Decimal(12, 2)
  TT_SO_TIEN_KHACH_DUA    Decimal?      @db.Decimal(12, 2)
  TT_TIEN_THUA            Decimal?      @db.Decimal(12, 2)
  TT_NGAY_GIO             DateTime      @default(now())
  TT_NGAY_CAP_NHAT        DateTime      @updatedAt
  TT_MA_GIAO_DICH         String?
  TT_GHI_CHU              String?

  HOA_DON HOA_DON @relation(fields: [HDON_MA], references: [HDON_MA])

  @@index([HDON_MA, TT_TRANG_THAI_GIAO_DICH])
}

// Bảng nối: gộp nhiều Reservation vào 1 Invoice (và ngược lại)
model HOA_DON_HOP_DONG {
  HDON_MA  Int
  HDONG_MA Int

  HOA_DON            HOA_DON            @relation(fields: [HDON_MA], references: [HDON_MA], onDelete: Cascade)
  HOP_DONG_DAT_PHONG HOP_DONG_DAT_PHONG @relation(fields: [HDONG_MA], references: [HDONG_MA], onDelete: Cascade)

  @@id([HDON_MA, HDONG_MA])
}

// ---------- CHATBOT ----------
model ChatSession {
  id        Int      @id @default(autoincrement()) @map("ID_SESSION")
  guestId   Int?     @map("ID_KH")
  startedAt DateTime @default(now()) @map("STARTED_AT")

  guest    KHACH_HANG?   @relation(fields: [guestId], references: [KH_MA])
  messages ChatMessage[]

  @@map("CHAT_SESSION")
}

model ChatMessage {
  id        BigInt   @id @default(autoincrement()) @map("ID_MES")
  sessionId Int      @map("ID_SESSION")
  role      ChatRole @map("ROLE")
  content   String   @map("CONTENT")
  createdAt DateTime @default(now()) @map("CREATED_AT")

  session ChatSession @relation(fields: [sessionId], references: [id])

  @@index([sessionId, createdAt])
  @@map("CHAT_MESSAGE")
}

// ---------- KNOWLEDGE BASE ----------
model KbDocument {
  id        Int       @id @default(autoincrement()) @map("ID_DOC")
  title     String?   @map("TITLE")
  sourceUrl String?   @map("SOURCE_URL")
  tags      String?   @map("TAGS")
  createdAt DateTime  @default(now()) @map("CREATED_AT")
  chunks    KbChunk[]

  @@map("KB_DOCUMENT")
}

model KbChunk {
  id         Int      @id @default(autoincrement()) @map("ID_CHUNK")
  docId      Int      @map("ID_DOC")
  content    String   @map("CONTENT")
  embedding  Json     @map("EMBEDDING_JSON")
  tokenCount Int?     @map("TOKEN_COUNT")
  createdAt  DateTime @default(now()) @map("CREATED_AT")

  doc KbDocument @relation(fields: [docId], references: [id])

  @@index([docId])
  @@map("KB_CHUNK")
}
